<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
 <head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
  <title>插入公式</title>
  <script type="text/javascript" src="../internal.js"></script>
  <script type="text/javascript" src="../../third-party/MathJax/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
  <style type="text/css">
	*{margin:0;padding:0;}
	table{background-color:#C6DDFA;}
	#layout-wrap{height:320px;}
	td{border:1px solid #638EE6;}
	.symbol{margin:10px;}
	#layout-wrap .symbol table{border-collapse:separate;border-spacing:2px;}
	.symbol td{width:30px;height:30px;border:0;cursor:default;}
	#textarea{width:100%;border:0;overflow:auto;}
	.sym1{background:url(img/img.gif) no-repeat;}
	.sym2{background:url(img/img.gif) 0 -64px no-repeat;}
	.sym3{background:url(img/img.gif) 0 -96px no-repeat;}
	.sym4{background:url(img/img.gif) 0 -128px no-repeat;}
	.sym5{background:url(img/cmd.gif) no-repeat;}
  </style>
 </head>

 <body>
	<table	id="layout-wrap">
		<tr>
			<td>
				<div	class="symbol">
					<table	class="sym1">
						<tr>
							<td	data="\alpha"></td>
							<td	data="\beta"></td>
							<td	data="\gamma"></td>
							<td	data="\delta"></td>
							<td	data="\epsilon"></td>
							<td	data="\varepsilon"></td>
							<td	data="\zeta"></td>
							<td	data="\eta"></td>
							<td	data="\theta"></td>
							<td	data="\vartheta"></td>
							<td	data="\iota"></td>
							<td	data="\kappa"></td>
							<td	data="\lambda"></td>
							<td	data="\mu"></td>
							<td	data="\nu"></td>
							<td	data="\xi"></td>
							<td	data="\pi"></td>
							<td	data="\varpi"></td>
							<td	data="\rho"></td>
							<td	data="\varrho"></td>
							<td	data="\sigma"></td>
							<td	data="\varsigma"></td>
							<td	data="\tau"></td>
							<td	data="\upsilon"></td>
							<td	data="\phi"></td>
							<td	data="\varphi"></td>
							<td	data="\chi"></td>
							<td	data="\psi"></td>
							<td	data="\omega"></td>
						</tr>
					</table>
					<table	class="sym2">
						<tr>
							<td	data="\pm"></td>
							<td	data="\mp"></td>
							<td	data="\times"></td>
							<td	data="\div"></td>
							<td	data="\ast"></td>
							<td	data="\star"></td>
							<td	data="\circ"></td>
							<td	data="\bullet"></td>
							<td	data="\cdot"></td>
							<td	data="\oplus"></td>
							<td	data="\bigoplus"></td>
							<td	data="\ominus"></td>
							<td	data="\otimes"></td>
							<td	data="\bigotimes"></td>
							<td	data="\oslash"></td>
							<td	data="\odot"></td>
							<td	data="\bigodot"></td>
							<td	data="\biguplus"></td>
							<td	data="\exists"></td>
							<td	data="\ni"></td>
							<td	data="\forall"></td>
							<td	data="\neg"></td>
						</tr>
					</table>
					<table	class="sym3">
						<tr>
							<td	data="\in"></td>
							<td	data="\emptyset"></td>
							<td	data="\subset"></td>
							<td	data="\supset"></td>
							<td	data="\subseteq"></td>
							<td	data="\supseteq"></td>
							<td	data="\subseteqq"></td>
							<td	data="\supseteqq"></td>
							<td	data="\subsetneq"></td>
							<td	data="\supsetneq"></td>
							<td	data="\subsetneqq"></td>
							<td	data="\supsetneqq"></td>
							<td	data="\varsubsetneq"></td>
							<td	data="\varsupsetneq"></td>
							<td	data="\varsubsetneqq"></td>
							<td	data="\varsupsetneqq"></td>
							<td	data="\nsubseteq"></td>
							<td	data="\nsupseteq"></td>
							<td	data="\nsupseteqq"></td>
							<td	data="\sqsubset"></td>
							<td	data="\sqsupset"></td>
							<td	data="\sqsubseteq"></td>
							<td	data="\sqsupseteq"></td>
							<td	data="\Subset"></td>
							<td	data="\Supset"></td>
							<td	data="\bigcap"></td>
							<td	data="\bigcup"></td>
							<td	data="\bigsqcup"></td>
							<td	data="\bigvee"></td>
							<td	data="\bigwedge"></td>
						</tr>
					</table>
					<table	class="sym4">
						<tr>
							<td	data="="></td>
							<td	data="<"></td>
							<td	data=">"></td>
							<td	data="\leq"></td>
							<td	data="\geq"></td>
							<td	data="\leqq"></td>
							<td	data="\geqq"></td>
							<td	data="\leqslant"></td>
							<td	data="\geqslant"></td>
							<td	data="\neq"></td>
							<td	data="\lneq"></td>
							<td	data="\gneq"></td>
							<td	data="\lneqq"></td>
							<td	data="\gneqq"></td>
							<td	data="\lvertneqq"></td>
							<td	data="\gvertneqq"></td>
							<td	data="\nleq"></td>
							<td	data="\ngeq"></td>
							<td	data="\nleqslant"></td>
							<td	data="\ngeqslant"></td>
							<td	data="\nleqq"></td>
							<td	data="\ngeqq"></td>
						</tr>
					</table>
					<table	class="sym5">
						<tr>
							<td	data="{x}^{a}"></td>
							<td	data="{x}_{b}"></td>
							<td	data="{}^{a}_{b}x"></td>
							<td	data="\overset{a}{X}"></td>
							<td	data="\underset{b}{X}"></td>
							<td	data="\frac{a}{b}"></td>
							<td	data="\binom{n}{r}"></td>
							<td	data="\frac{\partial y}{\partial x}"></td>
							<td	data="\sqrt{x}"></td>
							<td	data="\sqrt[n]{x}"></td>
							<td	data="\sum_{n=0}^{\infty}"></td>
							<td	data="\prod_{n=1}^{\infty}"></td>
							<td	data="\int_{a}^{b}"></td>
							<td	data="\oint_{1}^{n}"></td>
							<td	data="\iint_{1}^{2}"></td>
							<td	data="\iiint"></td>
							<td	data="\log_{e} x^{2}"></td>
							<td	data="\lim_{n \to \infty}"></td>
							<td	data="{e}^{-i \theta}"></td>
							<td	data="\left( \right)"></td>
							<td	data="\left[ \right]"></td>
							<td	data="\left| \right|"></td>
							<td	data="\left\| \right\|"></td>
							<td	data="\left\{ \right\}"></td>
							<td	data="\begin{cases}
 & \text{ if } x=  \\ 
 & \text{ if } x= 
 \end{cases}"></td>
							<td	data="\begin{matrix}
  a & b \\ 
 c & d 
\end{matrix}"></td>
							<td	data="\begin{bmatrix}
  \cdots &  &  \\ 
   & \cdots &  \\ 
   &  & \cdots 
 \end{bmatrix}"></td>
							<td	data="\begin{pmatrix}
 \ a & b \\ 
 c & d 
\end{pmatrix}"></td>
							<td	data="\begin{bmatrix}
 \ a & b \\ 
 c & d 
\end{bmatrix}"></td>
							<td	data="\begin{vmatrix}
 \ a & b \\ 
 c & d 
\end{vmatrix}"></td>
							<td	data="\begin{Vmatrix}
 \ a & b \\ 
 c & d 
\end{Vmatrix}"></td>
							<td	data="\begin{Bmatrix}
 \ a & b \\ 
 c & d 
\end{Bmatrix}"></td>
						</tr>
					</table>
				</div>
			</td>
		</tr>
		<tr>
			<td	colspan="2">公式输入：<br /><textarea id="textarea" rows="8"></textarea>
			</td>
		</tr>
		<tr>
			<td	colspan="2"	id="result-area">公式预览：<br />$${}$$</td>
		</tr>
	</table>
	<script type="text/javascript">
		var layoutWrap = document.getElementById('layout-wrap'),
			textEditor = document.getElementById('textarea'),
			bk;

        textEditor.focus();
		textEditor.onmouseup = function (){
			document.selection && (bk = document.selection.createRange().getBookmark());
		};
		textEditor.onkeyup = function (){
			updateFormula.call(this, this.value);
		};
		layoutWrap.onclick = function (e){
			var e = e || window.event,
				target = e.target||e.srcElement,
				signal,
				posStart,
				posEnd;
			if (target.tagName.toLowerCase() === 'td' && (signal = target.getAttribute('data'))){
				if(!((posStart=textEditor.selectionStart)!=undefined && (posEnd=textEditor.selectionEnd)!=undefined))
				{
					var range = textEditor.createTextRange();
					range.moveToBookmark(bk);
					range.select();
					var pos = getPos();
					posStart = pos[0];
					posEnd = pos[1];
				}
				textEditor.value = textEditor.value.slice(0, posStart) + signal + textEditor.value.slice(posEnd);
				updateFormula(textEditor.value);
			}
		};
		function updateFormula(text){
			var tmr = arguments.callee.tmr;

			tmr && window.clearTimeout(tmr);
			arguments.callee.tmr = setTimeout(function (){
				MathJax.Hub.queue.Push(["Text",MathJax.Hub.getAllJax("result-area")[0],"\\displaystyle{"+text+"}"]);
			}, 1000);

		}
		function getPos(){
			var start,end;
			var range = document.selection.createRange();
			var range_all = document.body.createTextRange();
			var textBox = document.getElementById('textarea');
			range_all.moveToElementText(textBox);
			for (start=0; range_all.compareEndPoints("StartToStart", range) < 0; start++)
			 range_all.moveStart('character', 1);
			for (var i = 0; i <= start; i ++){
			 if (textBox.value.charAt(i) == '\n')
				 start++;
			}
			var range_all = document.body.createTextRange();
			range_all.moveToElementText(textBox);

			for (end = 0; range_all.compareEndPoints('StartToEnd', range) < 0; end ++)
			  range_all.moveStart('character', 1);

			for (var i = 0; i <= end; i ++){
			  if (textBox.value.charAt(i) == '\n')
				  end ++;
			}
			return [start, end];
		}

		var state = editor.queryCommandState("insertformula");
        if(state){
			var ele = domUtils.findParent(editor.selection.getRange().startContainer,function(node){
				return node.className==='math-container';
			});
			textEditor.value = decodeURIComponent(ele.getAttribute('data'));
			updateFormula(textEditor.value)
		}
        dialog.onok = function (){
            var textValue = textEditor.value.replace(/(^\s*)|(\s*$)/g,'');
            if (textValue.length>0){
                var mathjaxDom = document.getElementById('result-area').lastChild;
                do{
                    mathjaxDom = mathjaxDom.previousSibling;
                }
                while (mathjaxDom && mathjaxDom.className!='MathJax_Display');

                if(state==0){
                        editor.execCommand('insertFormula', '<span id="math-container-id" class="math-container" data="'+encodeURIComponent(textValue)+'">$$'+textValue+'$$</span>');
                        var ele = editor.selection.getRange().startContainer,
                            ele = domUtils.findParent(ele,function(node){
                            				return node.nodeType === 1;
                            			});
                        (editor.document.defaultView||editor.document.parentWindow).MathJax.Hub.Typeset(ele);

                }
                else{
                    ele = editor.selection.getRange().startContainer,
                    ele = domUtils.findParent(ele,function(node){
                        return node.className==='math-container';
                    });
                    (editor.document.defaultView||editor.document.parentWindow).MathJax.Hub.getJaxFor(ele.lastChild).Text(textValue);
                }
            }
        }
	</script>
 </body>
</html>
